#!/usr/bin/env ruby
$LOAD_PATH << File.join(File.dirname(__FILE__), "..", "lib")
require 'lifx'
require 'time'

matchers = ARGV.map do |arg|
  Regexp.new(arg, Regexp::IGNORECASE)
end

if matchers.empty?
  matchers << //
end

begin
  light_udp = LIFX::Transport::UDP.new('0.0.0.0', 56700)
  light_udp.add_observer(self) do |message:, ip:, transport:|
    if matchers.any? { |m| message.to_s =~ m }
      puts "#{Time.now.iso8601(5)} BROADCAST: #{ip} #{message}"
    end
  end
  light_udp.listen

  peer_udp = LIFX::Transport::UDP.new('0.0.0.0', 56750)
  peer_udp.add_observer(self) do |message:, ip:, transport:|
    if matchers.any? { |m| message.to_s =~ m }
      puts "#{Time.now.iso8601(5)} PEER:      #{ip} #{message}"
    end
  end
  peer_udp.listen
rescue LIFX::Message::UnsupportedProtocolVersion
end

puts "Listening on 56700 and 56750..."
puts "^C to quit."

sleep
